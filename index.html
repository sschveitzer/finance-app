<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entrar</title>
  <link rel="icon" type="image/jpeg" href="img/logo.png">
  <link rel="stylesheet" href="style.css">
</head>
<body class="center">
  <main class="login-card">
    <img class="login-logo" src="img/logo.png" alt="Logo do sistema">
    <h2>Sistema de Gestão</h2>
    <p class="subtitle">Faça seu login para acessar o Dashboard.</p>

    <form id="form-login" novalidate>
      <div class="form-field">
        <label for="email">E-mail</label>
        <div class="input">
          <span class="i i-mail" aria-hidden="true"></span>
          <input id="email" type="email" placeholder="voce@exemplo.com" required />
        </div>
      </div>

      <div class="form-field">
        <label for="password">Senha</label>
        <div class="input">
          <span class="i i-lock" aria-hidden="true"></span>
          <input id="password" type="password" placeholder="••••••••" required minlength="6" />
        </div>
      </div>

      <button id="btn" class="btn btn-login" type="submit">Entrar</button>
      <p id="msg" class="erro-msg"></p>
    </form>
  </main>

  <footer><p>© 2025 Chama do Céu - Todos os direitos reservados | <a href="privacidade.html">Política de Privacidade</a></p></footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://ppoufxezqmbxzflijmpx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwb3VmeGV6cW1ieHpmbGlqbXB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NzY1MTgsImV4cCI6MjA3MjE1MjUxOH0.7wntt2EbXsb16Zob9F81XFUKognKHKn0jxP6UdfF_ZY';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });

    // redireciona se já logado
    sb.auth.getUser().then(({ data:{ user } }) => { if (user) location.href = 'dashboard.html'; });

    document.getElementById('form-login').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const msg = document.getElementById('msg');
      msg.textContent = 'Entrando...';
      msg.classList.remove('show');

      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) {
        msg.textContent = 'Erro: ' + (error.message || 'login inválido');
        msg.classList.add('show');
        return;
      }

      // whitelist
      const wl = await sb.from('app_allowed_emails').select('email').eq('email', email.toLowerCase()).maybeSingle();
      if (wl.error || !wl.data) {
        await sb.auth.signOut();
        msg.textContent = 'Acesso negado para este e-mail.';
        msg.classList.add('show');
        return;
      }

      location.href = 'dashboard.html';
    });
  </script>
</body>
</html>
